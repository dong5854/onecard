<html>
<head>
    <title>onecard gameServer Test</title>
    <script>
        let serverURL;
        let socket;
        function setUpSocket() {
            serverURL = 'ws://0.0.0.0:8080/game';
            socket = new WebSocket(serverURL);

            socket.onopen = logOpenToConsole;
            socket.onmessage = readAndDisplayGameState;
            socket.onclose = logCloseToConsole;
        }

        function readAndDisplayGameState(event) {
            const gameState = JSON.parse(event.data);
            logGameStatusToConsole(gameState["gameStatus"]);
            renderCurrentGameStatus(event.data);
        }

        function logGameStatusToConsole(gameStatus) {
            console.log(`Received ${gameStatus}`);
        }

        function logCloseToConsole() {
            console.log("Web socket connection closed");
        }

        function logOpenToConsole() {
            console.log("Web socket connection opened");
        }

        function renderCurrentGameStatus(gameState) {
            document.getElementById("currentGameStatus").appendChild(div(gameState));
        }

        function div(text) {
            const node = document.createElement("div");
            node.appendChild(document.createTextNode(text));
            return node;
        }

        function getFormValue(id, name) {
            const e = document.getElementById(id);
            return e[name].value;
        }

        function getSelectedDropDownValue(id) {
            const e = document.getElementById(id);
            return e.options[e.selectedIndex].text;
        }

        function buildGameStatusFromForm() {
            const players = [getFormValue("gameStatusToSend", "player1"), getFormValue("gameStatusToSend", "player2"),
                             getFormValue("gameStatusToSend", "player3"), getFormValue("gameStatusToSend", "player4")];
            const currentPlayerIndex = players.length;
            const deck = [{
                rank: 1,
                suit: "diamond",
                isJoker: false,
            },{
                rank: 2,
                suit: "heart",
                isJoker: false,
            }]
            const discardPile = [{
                isJoker: true,
            }]
            const direction = getSelectedDropDownValue("gameStatusToSend");
            const damage = getFormValue("gameStatusToSend", "damage")
            return {
                players, currentPlayerIndex, deck, discardPile,
                direction, damage,
                gameStatus: 'playing',
                settings: {
                    numberOfPlayers: 4,
                    includeJokers: false,
                    initHandSize : 5,
                    maxHandSize: 7
                }
            }
        }

        function logSendingToConsole(data) {
            console.log("About to send", data);
        }

        function sendGameStatusViaSocket(data) {
            socket.send(JSON.stringify(data));
        }

        function sendGameStatusToServer() {
            const gameStatus = buildGameStatusFromForm();
            logSendingToConsole(gameStatus);
            sendGameStatusViaSocket(gameStatus);
            //prevent form submission
            return false;
        }
    </script>
</head>
<body onload="setUpSocket()">

<h1>get gameStatus by websockets</h1>
<form action="javascript:renderCurrentGameStatus()">
    <input type="submit" value="render current game status">
</form>
<div id="currentGameStatus" />


<h3>update game status</h3>
<form id="gameStatusToSend" onsubmit="return sendGameStatusToServer()">
    <div>
        <label>Player1: </label>
        <input type="text" id="player1"
               name="player1" size="20">
    </div>
    <div>
        <label>Player2: </label>
        <input type="text" id="player2"
               name="player2" size="20">
    </div>
    <div>
        <label>Player3: </label>
        <input type="text" id="player3"
               name="player3" size="20">
    </div>
    <div>
        <label>Player4: </label>
        <input type="text" id="player4"
               name="player4" size="20">
    </div>
    <div>
        <label>damage: </label>
        <input type="number" id="damage"
               name="damage" size="5">
    </div>
    <select>
        <option value="clockwise" selected="selected">clockwise</option>
        <option value="counterclockwise">counterclockwise</option>
    </select>
    <input type="submit">
</form>
</body>
</html>
